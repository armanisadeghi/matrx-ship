# Server Bootstrap Guide

How to set up the full Matrx infrastructure from scratch on a new server.

**Everything here is recreatable from 3 git repos + a few secrets.**

---

## Prerequisites

- Ubuntu/Debian server with Docker and Docker Compose installed
- Domain `*.dev.codematrx.com` pointing to the server IP
- Git, Node.js 22+, pnpm 10.28+

---

## Directory Structure

```
/srv/
├── traefik/          # Reverse proxy (created by bootstrap)
├── postgres/         # Shared PostgreSQL (created by bootstrap)
├── mcp-servers/      # Server Manager + MCP tools (created by bootstrap)
├── apps/             # Ship instance runtime data (created by server-manager)
│   ├── deploy/       # Deploy app runtime
│   ├── {instance}/   # Per-instance dirs (auto-created)
│   ├── deployments.json
│   ├── tokens.json
│   └── build-history.json
└── projects/         # Git repos (THE SOURCE OF TRUTH)
    ├── matrx-ship/        # github.com/armanisadeghi/matrx-ship
    ├── matrx-sandbox/     # github.com/armanisadeghi/matrx-sandbox
    └── (dev-tools merged into matrx-ship/cli/)
```

---

## Secrets You Need

These are NOT in git. You must have them to set up a server:

| Secret | Where it goes | How to get it |
|--------|--------------|---------------|
| `MCP_BEARER_TOKEN` | `/srv/mcp-servers/.env` | Generate: `openssl rand -hex 32` |
| `AWS_ACCESS_KEY_ID` | `/srv/mcp-servers/.env`, `/srv/apps/deploy/.env` | AWS IAM user `matrx-server-backup` |
| `AWS_SECRET_ACCESS_KEY` | `/srv/mcp-servers/.env`, `/srv/apps/deploy/.env` | Same IAM user |
| `TRAEFIK_DASHBOARD_AUTH` | `/srv/traefik/.env` | Generate: `htpasswd -nb admin <password>` |
| `POSTGRES_PASSWORD` (global) | `/srv/postgres/.env` | Generate any strong password |
| `PGADMIN_PASSWORD` | `/srv/postgres/.env` | Generate any strong password |

Per-instance secrets (auto-generated by server-manager when creating instances):
- `POSTGRES_PASSWORD` (per instance)
- `MATRX_SHIP_API_KEY` (per instance)

---

## Step-by-Step Bootstrap

### 1. Clone the repos

```bash
mkdir -p /srv/projects
cd /srv/projects
git clone https://github.com/armanisadeghi/matrx-ship.git
git clone https://github.com/armanisadeghi/matrx-sandbox.git
# matrx-dev-tools is now part of matrx-ship (see cli/ directory)
```

### 2. Create the Docker network

```bash
docker network create proxy
```

### 3. Set up Traefik (reverse proxy)

```bash
mkdir -p /srv/traefik/{dynamic,acme}

cat > /srv/traefik/.env << 'EOF'
DOMAIN=dev.codematrx.com
TRAEFIK_DASHBOARD_AUTH=admin:$$2y$$05$$GENERATE_THIS_WITH_HTPASSWD
EOF

cat > /srv/traefik/traefik.yml << 'EOF'
api:
  dashboard: true

entryPoints:
  web:
    address: ":80"
    http:
      redirections:
        entryPoint:
          to: websecure
          scheme: https
  websecure:
    address: ":443"
    http3: {}

certificatesResolvers:
  letsencrypt:
    acme:
      email: admin@codematrx.com
      storage: /acme/acme.json
      httpChallenge:
        entryPoint: web

providers:
  docker:
    exposedByDefault: false
    network: proxy
  file:
    directory: /etc/traefik/dynamic
    watch: true
EOF

cat > /srv/traefik/docker-compose.yml << 'EOF'
services:
  traefik:
    image: traefik:v3.3
    container_name: traefik
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik.yml:/etc/traefik/traefik.yml:ro
      - ./dynamic:/etc/traefik/dynamic:ro
      - ./acme:/acme
      - traefik-logs:/var/log/traefik
    networks:
      - proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`traefik.${DOMAIN}`)"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.middlewares=auth"
      - "traefik.http.middlewares.auth.basicauth.users=${TRAEFIK_DASHBOARD_AUTH}"

volumes:
  traefik-logs:

networks:
  proxy:
    external: true
EOF

cd /srv/traefik && docker compose up -d
```

### 4. Set up PostgreSQL (shared)

```bash
mkdir -p /srv/postgres

cat > /srv/postgres/.env << 'EOF'
POSTGRES_USER=matrx
POSTGRES_PASSWORD=GENERATE_A_STRONG_PASSWORD
POSTGRES_DB=matrx
PGADMIN_EMAIL=admin@matrxserver.com
PGADMIN_PASSWORD=GENERATE_A_STRONG_PASSWORD
EOF

# Create docker-compose.yml for postgres (see existing server for reference)
cd /srv/postgres && docker compose up -d
```

### 5. Build the matrx-ship Docker image

```bash
cd /srv/projects/matrx-ship
docker build -t matrx-ship:latest .
```

### 6. Set up the MCP Server Manager

The server manager source lives at `/srv/projects/matrx-ship/deploy/../` — but the
running infrastructure is at `/srv/mcp-servers/`. The source code for the server manager
is embedded in the matrx-ship repo's git history and the Docker image build process.

**TODO:** The `/srv/mcp-servers/` directory needs to be either:
- (a) Moved into one of the 3 git repos, or
- (b) Given its own git repo with a remote

For now, recreate it:

```bash
mkdir -p /srv/mcp-servers/servers/server-manager

cat > /srv/mcp-servers/.env << 'EOF'
MCP_BEARER_TOKEN=GENERATE_WITH_openssl_rand_hex_32

# AWS S3
AWS_ACCESS_KEY_ID=YOUR_KEY
AWS_SECRET_ACCESS_KEY=YOUR_SECRET
AWS_DEFAULT_REGION=us-east-1
S3_BACKUP_BUCKET=matrx-server-backups-prod
EOF

# docker-compose.yml and server source need to be restored from backup or repo
cd /srv/mcp-servers && docker compose up -d
```

### 7. Set up the Deploy App

```bash
mkdir -p /srv/apps/deploy

cat > /srv/apps/deploy/.env << 'EOF'
AWS_ACCESS_KEY_ID=YOUR_KEY
AWS_SECRET_ACCESS_KEY=YOUR_SECRET
AWS_DEFAULT_REGION=us-east-1
S3_BACKUP_BUCKET=matrx-server-backups-prod
EOF

# docker-compose.yml references /srv/projects/matrx-ship/deploy/ as build context
cat > /srv/apps/deploy/docker-compose.yml << 'EOF'
services:
  deploy-app:
    build:
      context: /srv/projects/matrx-ship/deploy
      dockerfile: Dockerfile
    container_name: matrx-deploy
    restart: unless-stopped
    env_file:
      - .env
    environment:
      NODE_ENV: production
      HOST_SRV_PATH: /host-srv
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_DEFAULT_REGION: ${AWS_DEFAULT_REGION}
      S3_BACKUP_BUCKET: ${S3_BACKUP_BUCKET}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /srv:/host-srv
    networks:
      - proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.matrx-deploy.rule=Host(`deploy.dev.codematrx.com`)"
      - "traefik.http.routers.matrx-deploy.entrypoints=websecure"
      - "traefik.http.routers.matrx-deploy.tls.certresolver=letsencrypt"
      - "traefik.http.services.matrx-deploy.loadbalancer.server.port=3000"

networks:
  proxy:
    external: true
EOF

cd /srv/apps/deploy && docker compose up -d --build
```

### 8. Create ship instances

Use the server manager UI at `https://mcp.dev.codematrx.com/admin/` or MCP tools to
create instances. Each instance gets auto-generated credentials.

---

## Critical Gap: `/srv/mcp-servers/` Is Not in Git

**This is the biggest persistence risk.** The server manager code (Express backend,
React admin UI, MCP tools) lives at `/srv/mcp-servers/` which has NO remote git repo.

**Options to fix:**
1. Create a `github.com/armanisadeghi/mcp-servers` repo and push it
2. Move the server manager code into `/srv/projects/matrx-ship/mcp-server-manager/`

Until this is resolved, the server manager code will be lost on server teardown.

---

## AWS S3 Setup

- **Account:** 872515272894 (AI Matrx)
- **Bucket:** `matrx-server-backups-prod` (us-east-1)
- **IAM User:** `matrx-server-backup`
- **Policy:** `MatrxServerBackupS3Access` (PutObject, GetObject, ListBucket, DeleteObject, GetBucketLocation)
- **Lifecycle:** Images → Glacier after 30d, delete 180d. DB backups → Glacier 60d, delete 365d.

See `/srv/.arman/pending/AWS_SAVES.md` for full setup details.
