name: Deploy Specific Instance

on:
  workflow_dispatch:
    inputs:
      instance_name:
        description: 'Instance name to deploy (e.g., matrx-ship, ai-matrx-admin)'
        required: true
        type: string
      skip_build:
        description: 'Skip Docker build (use existing latest image)'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    name: Deploy Instance
    runs-on: ubuntu-latest
    environment:
      name: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate instance name
        run: |
          if [[ ! "${{ inputs.instance_name }}" =~ ^[a-z0-9][a-z0-9-]*[a-z0-9]$ ]]; then
            echo "‚ùå Invalid instance name format"
            echo "Must be lowercase alphanumeric with hyphens"
            exit 1
          fi
          echo "‚úÖ Instance name valid: ${{ inputs.instance_name }}"

      - name: Set up Docker Buildx
        if: ${{ !inputs.skip_build }}
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        if: ${{ !inputs.skip_build }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        if: ${{ !inputs.skip_build }}
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:manual-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Deploy instance via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          timeout: 60s
          command_timeout: 15m
          script: |
            set -e
            
            INSTANCE="${{ inputs.instance_name }}"
            INSTANCE_DIR="/srv/apps/$INSTANCE"
            
            echo "üöÄ Deploying instance: $INSTANCE"
            
            # Check if instance exists
            if [ ! -d "$INSTANCE_DIR" ]; then
              echo "‚ùå Instance directory not found: $INSTANCE_DIR"
              echo "Available instances:"
              ls -1 /srv/apps/ | grep -v "^backups$" | grep -v "^deployments.json$" | grep -v "^build-history.json$" | grep -v "^tokens.json$"
              exit 1
            fi
            
            # Check if docker-compose.yml exists
            if [ ! -f "$INSTANCE_DIR/docker-compose.yml" ]; then
              echo "‚ùå docker-compose.yml not found in $INSTANCE_DIR"
              exit 1
            fi
            
            cd "$INSTANCE_DIR"
            
            # Pull latest image if not skipping build
            if [ "${{ inputs.skip_build }}" != "true" ]; then
              echo "üì¶ Pulling latest Docker image..."
              docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
              docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest matrx-ship:latest
            fi
            
            # Restart the instance
            echo "üîÑ Restarting $INSTANCE..."
            docker compose up -d --force-recreate app
            
            echo "‚úÖ Instance restarted"
            
            # Extract subdomain from docker-compose.yml
            SUBDOMAIN=$(grep -oP 'Host\(`\K[^`]+' docker-compose.yml | head -1)
            
            # Phase 1: Wait for container to become healthy
            # IMPORTANT: Traefik v3 skips unhealthy containers entirely.
            # No healthy container ‚Üí no router ‚Üí no certificate.
            echo "üîç Waiting for container health..."
            HEALTHY=false
            for i in {1..18}; do
              HEALTH=$(docker inspect "$INSTANCE" --format '{{if .State.Health}}{{.State.Health.Status}}{{else}}none{{end}}' 2>/dev/null || echo "unknown")
              if [ "$HEALTH" = "healthy" ] || [ "$HEALTH" = "none" ]; then
                echo "  ‚úì Container is ${HEALTH} after $((i * 5))s"
                HEALTHY=true
                break
              fi
              echo "  Attempt $i/18: health=$HEALTH, waiting 5s..."
              sleep 5
            done
            
            if [ "$HEALTHY" = "false" ]; then
              echo "  ‚ö†Ô∏è Container did not become healthy within 90s"
              echo "  Traefik will NOT route to this container or issue a certificate"
              echo "  Last logs:"
              docker logs "$INSTANCE" --tail 10 2>&1 || true
              exit 1
            fi
            
            # Phase 2: Verify the app responds
            if [ -n "$SUBDOMAIN" ]; then
              HEALTH_URL="https://$SUBDOMAIN/api/health"
              echo "üåê Verifying app responds at $HEALTH_URL..."
              
              for i in {1..6}; do
                if curl -k -f -s "$HEALTH_URL" > /dev/null 2>&1; then
                  echo "  ‚úì App is responding!"
                  break
                fi
                echo "  Attempt $i/6 ‚Äî waiting 5s..."
                sleep 5
              done
              
              # Phase 3: Verify certificate (Traefik auto-issues for healthy containers)
              echo "üîê Checking Let's Encrypt certificate..."
              CERT_OK=false
              for i in {1..6}; do
                ISSUER=$(echo | openssl s_client -connect "$SUBDOMAIN:443" -servername "$SUBDOMAIN" 2>/dev/null | openssl x509 -noout -issuer 2>/dev/null || echo "")
                if echo "$ISSUER" | grep -q "Let's Encrypt"; then
                  echo "  ‚úÖ Let's Encrypt certificate verified!"
                  CERT_OK=true
                  break
                fi
                echo "  Attempt $i/6 ‚Äî ACME challenge in progress, waiting 10s..."
                sleep 10
              done
              
              if [ "$CERT_OK" = "false" ]; then
                echo "  ‚ö†Ô∏è Certificate not yet issued (may still be in progress)"
                echo "  This usually resolves within 1-2 minutes"
              fi
            else
              echo "  ‚ö†Ô∏è Could not extract subdomain from docker-compose.yml"
            fi

      - name: Notify deployment success
        if: success()
        run: |
          echo "‚úÖ Instance deployed successfully!"
          echo "Instance: ${{ inputs.instance_name }}"
          echo "Build skipped: ${{ inputs.skip_build }}"

      - name: Notify deployment failure
        if: failure()
        run: |
          echo "‚ùå Instance deployment failed!"
          echo "Instance: ${{ inputs.instance_name }}"
          echo "Check the logs above for details."
